## Generating Relative Abundance Plots

This Python script was used to generate **relative abundance plots** for the Flynn Bay dataset across three different taxonomic tools: **EMU, ConCompRA, and ngspeciesid**.  

The plots visualize the distribution of taxa per sample using TSV outputs from each tool.

---

### **Input Files**

For each tool, the script expects a directory containing TSV files:

- **EMU:** `*.tsv` files from EMU analysis
- **CONCOMPRA MAPPED:** `*.tsv` files generated by `concompra.py` with mapped reads only
- **CONCOMPRA UNMAPPED:** `*.tsv` files generated by `concompra.py` including unmapped reads
- **NGSPECIESID:** `*.tsv` files from ngspeciesid output

**Important columns required in each TSV:**

- `genus` → The taxonomic label (used as species/genus identifier)
- `abundance` → Relative or raw abundance of each taxon

> ⚠️ **Note:** This script can be easily adjusted to work at different taxonomic levels such as **species**, **genus**, or **phylum** by changing the column name used for aggregation (currently `genus`).

---

### **How Relative Abundance is Calculated**

1. **Load all TSVs per dataset directory.**
   - Reads the relevant taxonomic column (e.g., `genus`) and `abundance`.
2. **Aggregate abundances by taxon.**
   - Summing abundance values for the same taxon across OTUs or sequences.
3. **Transpose data to have samples as rows and taxa as columns.**
   - Each sample is identified by its filename (without `.tsv` extension).
4. **Normalize abundances per sample.**
   - Relative abundance = abundance of taxon / total abundance in that sample
5. **Thresholding for low-abundance taxa.**
   - Taxa with relative abundance below **2%** (default threshold) are grouped into an `"Other"` category.
6. **Handle special categories:**
   - `"Unmapped"` reads are given a consistent color if present.
   - `"Other"` category is always colored orange for clarity.
7. **Sort taxa columns alphabetically**, with `"Unmapped"` and `"Other"` at the end.
8. **Stacked bar plot generation:**
   - Each sample is a separate stacked bar.
   - Y-axis inverted to show high abundance at the bottom (1.0 → top).
   - Each taxon is assigned a consistent color across datasets.

---

### **Visualization**

- Plots are generated side by side for all datasets in a single figure.
- Legend is consolidated at the bottom, showing each taxon with its assigned color.
- The script saves the figure as **`FBI-GENUS.svg`**.
- Example color assignments for verification are printed at the end.

---

### **Summary**

- **Input:** TSV files from EMU, ConCompRA (mapped/unmapped), and ngspeciesid containing a taxonomic column (`species`, `genus`, or `phylum`) and `abundance`.
- **Processing:** Aggregate, normalize, threshold, and assign consistent colors per taxon.
- **Output:** A stacked bar plot showing relative abundance per sample, with `"Other"` and `"Unmapped"` categories clearly represented.

✅ **Tip:** To visualize different taxonomic levels (species, genus, phylum), update the column name in the script used for grouping. The rest of the workflow remains the same.
